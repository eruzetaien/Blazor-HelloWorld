@implements IDisposable

<div class="flex-center flex-col bg-gray-100 p-4 rounded-lg shadow-md relative w-1/3">
    <!-- Header -->
    <div class="w-full flex justify-between px-3 bg-primary text-white rounded-t-lg py-2">
        <h3>@Counter.Name</h3>
        <button @onclick="() => ShowModal = true" class="bg-blue-600 text-white px-4 py-2 rounded">
            Edit
        </button>
    </div>

    <!-- Value -->
    <p class="text-6xl my-4">@(Counter.Enabled? @Counter.CurrentValue : "--" )</p>

    <!-- Modal -->
    <Modal Title="Edit Counter"
           IsVisible="ShowModal"
           IsVisibleChanged="@(v => ShowModal = v)">
        <Body>
            <form @onsubmit="HandleSubmit">
                <div class="flex flex-col">
                    <label class="flex items-center justify-between">
                        <span>Enabled:</span>
                        <input type="checkbox" @bind="Enabled" />
                    </label>

                    <label class="flex items-center justify-between">
                        <span>Refresh Interval (sec):</span>
                        <input type="number" @bind="IntervalSeconds" min="1" class="w-20 border rounded px-1" />
                    </label>
                </div>

                <button type="submit" class="bg-green-600 text-white px-3 py-1 rounded">
                    Save
                </button>
            </form>
        </Body>
    </Modal>

</div>

@code {
    private bool Enabled { get; set; }
    private double IntervalSeconds { get; set; }
    private bool ShowModal { get; set; }

    [Parameter]
    public IAnomalyCounter Counter { get; set; } = default!;

    private void HandleSubmit()
    {
        ShowModal = false;
        var interval = TimeSpan.FromSeconds(IntervalSeconds);
        Counter.UpdateSettings(interval, Enabled);

        ShowModal = false;
        Console.WriteLine($"[{Counter.Name}] Settings applied: Enabled={Enabled}, Interval={interval}");
    }

    protected override void OnInitialized()
    {
        Enabled = Counter.Enabled;
        IntervalSeconds = Counter.RefreshInterval.TotalSeconds;

        Counter.Updated += OnCounterUpdated;
        _ = Counter.StartAsync();
    }

    private void OnCounterUpdated()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        Counter.Updated -= OnCounterUpdated;
        _ = Counter.StopAsync();
    }
}
